## ПЛАН B: StrategyProfile как слой терпимости, контекста и интерпретации

(без управления действиями и без доменной логики в коде)

---

## I. БАЗОВАЯ ИДЕЯ ПЛАНА B (ФИКСАЦИЯ И ТЕРМИНЫ)

**StrategyProfile** — это *декларативный профиль исполнения*, который:

* **НЕ является стратегией принятия решений**
* **НЕ управляет действиями агента**
* **НЕ анализирует среду выполнения**
* **НЕ реагирует на DOM / URL / mapping / candidates**
* **НЕ меняется динамически во время одного graph execution**

StrategyProfile существует **вне core-логики** и применяется как *набор параметров и контекста*, используемых:

* до старта графа,
* и при пост-интерпретации результата.

### StrategyProfile ИМЕЕТ ПРАВО ТОЛЬКО НА:

1. задание *терпимости* (budgets / thresholds),
2. добавление *декларативного текстового контекста* для planner,
3. перегрузку *allowed_actions* (однократно, до запуска),
4. интерпретацию результата (UX, объяснения).

---

## II. ГЛОБАЛЬНЫЕ ОГРАНИЧЕНИЯ (ЗАКОН ПЛАНА B)

Эти ограничения **абсолютны**.
Нарушение любого пункта = **Plan B деградирует в Plan A**.

---

### II.1. Абсолютно запрещено (НАВСЕГДА)

StrategyProfile **НЕ ИМЕЕТ ПРАВА**:

* ❌ добавлять **кодовые site-specific условия**
  *(if hostname == …, if url contains …)*

* ❌ анализировать DOM, mapping, candidates, page text

* ❌ читать или интерпретировать сигналы среды выполнения

* ❌ влиять на выбор следующего действия
  *(прямо или косвенно)*

* ❌ менять allowed_actions **по ходу выполнения**

* ❌ менять stop_reason enum или вводить новые terminal states

* ❌ добавлять новые FSM-стадии, узлы или переходы графа

* ❌ менять порядок или логику существующих узлов

* ❌ влиять на scorer, confidence, commit-path

* ❌ содержать правила вида
  **“если X → делай Y”**

**Ключевой инвариант:**

> StrategyProfile никогда не знает и не проверяет,
> **что агент “видит” или “нашёл”.**

---

## III. МОДЕЛЬ ПРИМЕНЕНИЯ ПРОФИЛЯ (КРИТИЧЕСКИ ВАЖНО)

### III.1. Когда применяется StrategyProfile

* Профиль применяется **ТОЛЬКО при старте нового graph execution**
* Все параметры профиля считаются **константами** внутри одного run

❌ Запрещено:

* менять профиль в середине выполнения
* “адаптировать” профиль по ходу графа

---

### III.2. Ручное переключение профиля (РАЗРЕШЕНО)

Разрешено и обязательно поддерживается:

* Переключение происходит:

  * **между пользовательскими запросами**
  * **без перезапуска runtime**
* Новый запрос → новый graph → новый StrategyProfile

---

## IV. МОДЕЛЬ ЗНАЧЕНИЙ ПО УМОЛЧАНИЮ (ФИКСАЦИЯ)

### Принятое решение:

**Параметры существуют по умолчанию БЕЗ профиля.
StrategyProfile — это override поверх DefaultSettings.**

### Причины:

* универсальный агент — first-class сценарий,
* профиль необязателен,
* отсутствие профиля = стабильное, ожидаемое поведение,
* профиль может быть частичным и неполным.

### Формальное правило:

* Есть `DefaultSettings`
* Есть `StrategyProfile`
* Итоговые параметры вычисляются как:

```
EffectiveSettings = DefaultSettings + overrides из StrategyProfile
```

Если поле не задано в профиле → используется default.

---

## V. КОНТРАКТ StrategyProfile (ПОЛНЫЙ, БЕЗ КОДА)

StrategyProfile может содержать **ТОЛЬКО следующие группы параметров**.

---

### V.1. Budgets / Терпимость (РАЗРЕШЕНО)

StrategyProfile **может перегружать**:

* max_no_progress_steps
* max_steps
* max_planner_calls
* max_auto_scrolls
* другие **уже существующие** бюджеты

#### Ограничения:

* ❌ нельзя вводить новые счётчики
* ❌ нельзя вводить условные бюджеты в коде
  *(“если листинг, то …”)*

⚠️ Допустимо:

* **текстовое описание ожиданий** (для planner prompt),
  но не кодовая логика.

---

### V.2. Allowed Actions (РАЗРЕШЕНО, С ЖЁСТКИМИ ГРАНИЦАМИ)

StrategyProfile **может напрямую перегружать allowed_actions**.

#### Правила:

* override применяется **один раз перед запуском графа**
* итоговый список:

  * должен быть **подмножеством глобально допустимых действий**

#### Запрещено:

* ❌ менять allowed_actions динамически
* ❌ менять allowed_actions в зависимости от страницы/DOM

**Allowed_actions — это профиль допуска,
а не стратегия поведения.**

---

### V.3. Параметризация planner prompt

(РАЗРЕШЕНО, СТРОГО ДЕКЛАРАТИВНО)

StrategyProfile **может добавлять контекст**, который:

* описывает **ожидаемый класс среды**
* формирует **semantic framing**, но не алгоритм

#### Разрешено:

* декларативные описания среды, например:

  * “ты работаешь с маркетплейсом”
  * “типичная цель — поиск и выбор товара”
* описание **ожидаемых артефактов страницы**
  *(как текст, без проверок)*:

  * поиск, карточки, корзина, фильтры
* расширение / override существующих текстовых флагов:

  * task_mode
  * explore_mode
  * avoid_search
  * listing_detected

#### Разрешено (ВАЖНО):

* указывать конкретные платформы **как класс среды**
  *(“Ozon, Amazon, Yandex Market”)*
  **БЕЗ кодовых if/else**

---

#### Запрещено:

* ❌ менять JSON schema
* ❌ менять function calling
* ❌ менять формат плана
* ❌ добавлять пошаговые инструкции
* ❌ подсказывать, что делать первым
* ❌ превращать prompt в альтернативный planner

**Формула:**

> StrategyProfile может **описывать мир**,
> но не **учить планировать**.

---

### V.4. UX и интерпретация результата (РАЗРЕШЕНО)

StrategyProfile **может**:

* задавать словарь интерпретаций terminal_reason
* задавать стиль UX-summary
* добавлять “человеческое объяснение” завершения

#### Ограничения:

* ❌ UX-интерпретация не влияет на stop_reason
* ❌ UX не меняет факт завершения
* ❌ UX не может инициировать новые действия

---

## VI. ЧЕГО StrategyProfile НЕ ИМЕЕТ ПРАВА ДЕЛАТЬ (КРАТКИЙ ЗАКОН)

StrategyProfile **НЕ МОЖЕТ**:

* управлять действиями
* анализировать страницу
* реагировать на среду
* менять ход графа
* влиять на commit
* содержать доменные if/else
* быть альтернативным planner’ом
* быть скрытым observe

**Ключевой принцип:**

> StrategyProfile описывает ожидания,
> но не проверяет реальность.

---

## VII. МИНИМАЛЬНЫЙ ПОРЯДОК РЕАЛИЗАЦИИ ПЛАНА B

1. Зафиксировать DefaultSettings как источник истины
2. Ввести StrategyProfile как override-объект
3. Реализовать механизм применения профиля:

   * перед созданием GraphState
4. Подключить профиль:

   * к budgets
   * к allowed_actions
   * к planner prompt (context only)
5. Подключить профиль к UX-summary
6. Добавить ручной выбор профиля:

   * при старте запроса
   * без рестарта runtime

---

## VIII. КРИТЕРИЙ УСПЕХА ПЛАНА B

Plan B считается реализованным, если:

* универсал работает без профиля
* профиль выбирается вручную
* профиль меняет терпимость и контекст
* в core нет доменных if/else
* StrategyProfile можно удалить без поломки системы
* архитектура остаётся прозрачной и проверяемой